name: Build and Deploy DotNet HelloWorld to Azure Container App

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  ENVIRONMENT: dev
  LOCATION: East US
  IMAGE_NAME: ghcr.io/mani7reddy/dotnethelloworld:latest

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # -----------------------------
      # üß© Checkout Code
      # -----------------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # -----------------------------
      # üê≥ Build and Push Docker Image
      # -----------------------------
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.IMAGE_NAME }}
          no-cache: true
          platforms: linux/amd64

      # -----------------------------
      # üîê Azure Login
      # -----------------------------
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      # -----------------------------
      # üèóÔ∏è Register Required Azure Providers
      # -----------------------------
      - name: Register Azure Providers
        run: |
          for ns in Microsoft.App Microsoft.OperationalInsights Microsoft.ContainerRegistry; do
            echo "Registering provider: $ns"
            az provider register --namespace $ns --wait || true
          done

      # -----------------------------
      # ‚öôÔ∏è Setup Terraform
      # -----------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.5

      # -----------------------------
      # üíæ Terraform Init + Safe Unlock
      # -----------------------------
      - name: Terraform Init + Safe Unlock
        working-directory: infra
        run: |
          echo "üöÄ Initializing Terraform..."
          terraform init -input=false -reconfigure -upgrade

          echo "üîç Checking for existing Terraform locks..."
          terraform force-unlock -force 87baccc5-4b9b-5f6c-d8e0-49866f46602f 2>&1 || echo "‚úÖ No active lock found ‚Äî continuing."
        continue-on-error: true
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      # -----------------------------
      # üîÑ Import Existing Azure Resources
      # -----------------------------
      - name: Import Existing Azure Resources
        working-directory: infra
        run: |
          RG_NAME="rg-dotnet-dev"
          LAW_NAME="log-dev"
          ENV_NAME="env-dev"
          APP_NAME="dotnethelloworld-dev"

          RG_ID="/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/$RG_NAME"
          LAW_ID="/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/$RG_NAME/providers/Microsoft.OperationalInsights/workspaces/$LAW_NAME"
          ENV_ID="/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/$RG_NAME/providers/Microsoft.App/managedEnvironments/$ENV_NAME"
          APP_ID="/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/$RG_NAME/providers/Microsoft.App/containerApps/$APP_NAME"

          echo "üîç Importing Azure resources if not already tracked..."
          terraform state show module.rg.azurerm_resource_group.rg >/dev/null 2>&1 || terraform import module.rg.azurerm_resource_group.rg "$RG_ID" || true
          terraform state show module.container_app.azurerm_log_analytics_workspace.law >/dev/null 2>&1 || terraform import module.container_app.azurerm_log_analytics_workspace.law "$LAW_ID" || true
          terraform state show module.container_app.azurerm_container_app_environment.env >/dev/null 2>&1 || terraform import module.container_app.azurerm_container_app_environment.env "$ENV_ID" || true
          terraform state show module.container_app.azurerm_container_app.app >/dev/null 2>&1 || terraform import module.container_app.azurerm_container_app.app "$APP_ID" || true
          echo "‚úÖ Import validation complete."
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      # -----------------------------
      # üìã Terraform Plan
      # -----------------------------
      - name: Terraform Plan
        working-directory: infra
        run: |
          terraform plan -lock=false -input=false \
            -var="environment=${{ env.ENVIRONMENT }}" \
            -var="location=${{ env.LOCATION }}" \
            -var="image_name=${{ env.IMAGE_NAME }}"
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      # -----------------------------
      # üöÄ Terraform Apply
      # -----------------------------
      - name: Terraform Apply
        working-directory: infra
        run: |
          terraform apply -lock=false -auto-approve \
            -var="environment=${{ env.ENVIRONMENT }}" \
            -var="location=${{ env.LOCATION }}" \
            -var="image_name=${{ env.IMAGE_NAME }}"
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      # -----------------------------
      # üåç Output Application URL + Health Check
      # -----------------------------
      - name: Show App URL and Validate Deployment
        working-directory: infra
        run: |
          echo "üåç Your App is Live at:"
          APP_URL=$(terraform output -raw app_url || echo "")
          if [ -z "$APP_URL" ]; then
            echo "‚ö†Ô∏è App URL not found ‚Äî check infra output."
          else
            echo "$APP_URL"
            echo "ü©∫ Running health check..."
            curl -fsSL "$APP_URL" && echo "‚úÖ Health check passed!" || echo "‚ö†Ô∏è Health check failed!"
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
