name: Deploy DotNet HelloWorld to Azure Container App

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  ENVIRONMENT: dev
  LOCATION: East US
  IMAGE_NAME: ghcr.io/mani7reddy/dotnethelloworld:latest

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # üß© Checkout Code
      # -----------------------------
      - name: Checkout Code
        uses: actions/checkout@v4

      # -----------------------------
      # üîê Azure Login
      # -----------------------------
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.AZURE_CLIENT_ID }}",
              "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}",
              "subscriptionId": "${{ secrets.AZURE_SUBSCRIPTION_ID }}",
              "tenantId": "${{ secrets.AZURE_TENANT_ID }}"
            }

      # -----------------------------
      # üèóÔ∏è Register Required Azure Providers
      # -----------------------------
      - name: Register Azure Providers
        run: |
          az provider register --namespace Microsoft.App --wait || true
          az provider register --namespace Microsoft.OperationalInsights --wait || true
          az provider register --namespace Microsoft.ContainerRegistry --wait || true

      # -----------------------------
      # ‚öôÔ∏è Setup Terraform
      # -----------------------------
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.8.5

      # -----------------------------
      # üíæ Terraform Init
      # -----------------------------
      - name: Terraform Init
        working-directory: infra
        run: terraform init -input=false -reconfigure
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      # -----------------------------
      # üß† Import Existing Azure Resources (RG + LAW + Environment)
      # -----------------------------
      - name: Import Existing Azure Resources (RG + LAW + Environment)
        working-directory: infra
        run: |
          # ====== Resource Group Import ======
          RG_NAME="rg-dotnet-dev"
          RG_EXISTS=$(az group exists --name $RG_NAME)
          RG_IN_STATE=$(terraform state list | grep "module.rg.azurerm_resource_group.rg" || true)

          if [ "$RG_EXISTS" = "true" ] && [ -z "$RG_IN_STATE" ]; then
            echo "‚úÖ RG exists in Azure but not in state ‚Äî importing..."
            terraform import -input=false \
              module.rg.azurerm_resource_group.rg \
              /subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/$RG_NAME || true
          elif [ -n "$RG_IN_STATE" ]; then
            echo "‚ÑπÔ∏è RG already managed by Terraform ‚Äî skipping import."
          else
            echo "‚ÑπÔ∏è RG does not exist ‚Äî Terraform will create it."
          fi

          # ====== Log Analytics Workspace Import ======
          LAW_NAME="log-dev"
          LAW_ID="/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/$RG_NAME/providers/Microsoft.OperationalInsights/workspaces/$LAW_NAME"
          LAW_EXISTS=$(az monitor log-analytics workspace show --resource-group $RG_NAME --workspace-name $LAW_NAME --query id -o tsv 2>/dev/null || true)
          LAW_IN_STATE=$(terraform state list | grep "module.container_app.azurerm_log_analytics_workspace.law" || true)

          if [ -n "$LAW_EXISTS" ] && [ -z "$LAW_IN_STATE" ]; then
            echo "‚úÖ Log Analytics Workspace exists ‚Äî importing..."
            terraform import -input=false module.container_app.azurerm_log_analytics_workspace.law "$LAW_ID" || true
          elif [ -n "$LAW_IN_STATE" ]; then
            echo "‚ÑπÔ∏è Log Analytics Workspace already managed ‚Äî skipping import."
          else
            echo "‚ÑπÔ∏è Log Analytics Workspace not found ‚Äî Terraform will create it."
          fi

          # ====== Container App Environment Import ======
          ENV_NAME="env-dev"
          ENV_ID="/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/$RG_NAME/providers/Microsoft.App/managedEnvironments/$ENV_NAME"
          ENV_EXISTS=$(az resource show --ids "$ENV_ID" --query id -o tsv 2>/dev/null || true)
          ENV_IN_STATE=$(terraform state list | grep "module.container_app.azurerm_container_app_environment.env" || true)

          if [ -n "$ENV_EXISTS" ] && [ -z "$ENV_IN_STATE" ]; then
            echo "‚úÖ Container App Environment exists ‚Äî importing..."
            terraform import -input=false module.container_app.azurerm_container_app_environment.env "$ENV_ID" || true
          elif [ -n "$ENV_IN_STATE" ]; then
            echo "‚ÑπÔ∏è Container App Environment already managed ‚Äî skipping import."
          else
            echo "‚ÑπÔ∏è Container App Environment not found ‚Äî Terraform will create it."
          fi
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      # -----------------------------
      # üìã Terraform Plan
      # -----------------------------
      - name: Terraform Plan
        working-directory: infra
        run: |
          terraform plan -input=false \
            -var="environment=${{ env.ENVIRONMENT }}" \
            -var="location=${{ env.LOCATION }}" \
            -var="image_name=${{ env.IMAGE_NAME }}"
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      # -----------------------------
      # üöÄ Terraform Apply
      # -----------------------------
      - name: Terraform Apply
        working-directory: infra
        run: |
          terraform apply -auto-approve \
            -var="environment=${{ env.ENVIRONMENT }}" \
            -var="location=${{ env.LOCATION }}" \
            -var="image_name=${{ env.IMAGE_NAME }}"
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      # -----------------------------
      # üåç Output Application URL
      # -----------------------------
      - name: Get App URL
        working-directory: infra
        run: terraform output -raw app_url > app_url.txt
        env:
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}

      - name: Show App URL
        run: |
          echo "üåç Your App is Live at:"
          cat infra/app_url.txt
